---
title: "Research compendium"
output: 
  distill::distill_article:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)
```

<style>
div.box-info p{padding:1em;margin:20px 0;background:#DDECF6;border:1px solid #CEE9F2;border-radius:10px;color:#487997;border-left:5px solid #487997;}
div.box-header p{padding:1em;margin:20px 0;margin-top:0;background:#D5E6DE;border:1px solid #C0DACD;border-radius:10px;color:#567763;border-left:5px solid #567763;}
</style>



::: {.box-header}
`r fontawesome::fa_i("bullseye")`
L'objectif de cet exercice est de créer un _**research compendium**_, c.-à-d. un dossier de travail dont la structure est dérivée de celle d'un package `r fontawesome::fa_i("r-project")`.
Ce _**research compendium**_ servira de base de travail tout au long de la formation.
:::

`r fontawesome::fa_i("lightbulb")` **Cet exercice s'inspire beaucoup du [workshop](https://annakrystalli.me/rrtools-repro-research/intro.html) proposé par [Anna Krystalli](https://annakrystalli.me/).**

<br/>

Afin de nous assister dans la création de la structure de notre dossier de travail,
nous allons utiliser le package `r fontawesome::fa_i("r-project")` [`rcompendium`](https://github.com/frbcesab/rcompendium), développé dans le cadre 
de cette formation. Il permet d'automatiser la création des fichiers/répertoires
spécifiques à un compendium/package. Le package `r fontawesome::fa_i("r-project")` `rcompendium` s'inspire en grande partie du package `r fontawesome::fa_i("r-project")` [`rrtools`](https://github.com/benmarwick/rrtools)
et repose sur le package `r fontawesome::fa_i("r-project")` [`usethis`](https://usethis.r-lib.org/). Merci aux développeurs de ces packages.


<br />

## Préambule

Installez le package `r fontawesome::fa_i("r-project")` `rcompendium` depuis le CRAN :

```{r}
## Installation de 'rcompendium' ----
install.packages("rcompendium")
```

Une fois le package installé, vous devez exécuter la fonction [`set_credentials()`](https://frbcesab.github.io/rcompendium/reference/set_credentials.html) afin de stocker localement vos informations
personnelles (prénom, nom, email, ORCID, protocole de communication avec GitHub).
Ces informations permettront de remplir automatiquement certains fichiers. **Cette
fonction n'est à utiliser qu'une seule fois**.

```{r}
## Stockage de vos informations ----
rcompendium::set_credentials(given    = "Jane",
                             family   = "Doe", 
                             email    = "jane.doe@mail.me", 
                             orcid    = "0000-0000-0000-0000", 
                             protocol = "ssh")
```

Ces informations ont été stockées dans le fichier `~/.Renviron`, fichier qui est lu
à chaque ouverture de `r fontawesome::fa_i("r-project")`.


```{r}
## Vérification (après redemarrage de R) ----
options()$"email"
# [1] "jane.doe@mail.me"
```


Finalement, vérifiez que vous avez bien suivi les [instructions](https://rdatatoolbox.github.io/instructions.html) pour configurer **git** en exécutant la commande `gh::gh_whoami()`. Vous devriez voir s'afficher :

```
{
  "name": "Jane Doe",
  "login": "jdoe",
  "html_url": "https://github.com/jdoe",
  "scopes": "admin:repo_hook, repo, workflow",
  "token": "ghp_...ZZ9z"
} 
```


<br />

## Projet RStudio

Créez un nouveau projet RStudio : `File > New Project > New Directory > New Project`

- Choisissez un nom pour votre projet : par ex., `demo.compendium`
- Sélectionnez l'emplacement où le nouveau projet sera créé
- Décochez toutes les autres cases et validez


::: {.box-info}
`r fontawesome::fa_i("lightbulb")` **Bonne pratique #1**
<br/>
Toujours travailler dans un **Projet RStudio**. Cela présente l'avantage de simplifier les chemins d'accès aux fichiers, notamment avec le package `r fontawesome::fa_i("r-project")` [`here`](https://here.r-lib.org/) et sa fonction `here()`. Les chemins d'accès seront toujours construits par rapport au dossier contenant le fichier `.Rproj` (racine du projet). On parle de _chemin relatif_. N'utilisez **plus jamais** la fonction `setwd()`.
:::



<br />

## Fichier `DESCRIPTION`

Le fichier `DESCRIPTION` décrit les métadonnées du projet (titre, auteur, description, packages requis, etc.). C'est un des éléments essentiels d'un package `r fontawesome::fa_i("r-project")`. Ici, nous allons le _détourner_ pour l'utiliser dans le cadre d'un compendium afin de bénéficier des outils de développement de packages `r fontawesome::fa_i("r-project")`.

```{r}
## Ajout d'un fichier DESCRIPTION ----
rcompendium::add_description()
```

Comme vous le voyez, ce fichier a été pré-rempli avec vos informations personnelles.
Vous éditerez les champs `Title` et `Description` plus loin.


::: {.box-info}
`r fontawesome::fa_i("lightbulb")` **Bonne pratique #2**
<br/>
Toujours ajouter un fichier **`DESCRIPTION`** à la racine du projet. En plus de la description du projet, il permet de lister les packages dont le projet dépend (tag `Imports` et `Remotes`). Avec ce fichier, plus besoin d'utiliser les fonctions `install.packages()` et `library()`. Elles seront remplacées respectivement par `devtools::install_deps()` et `devtools::load_all()`.
:::



<br />

## Choix d'une Licence

Tout matériel partagé en ligne doit disposé d'une licence qui décrit ce qu'il est
possible de faire avec. Ainsi, nous vous recommandons d'ajouter **dès le début du projet** une licence. Pour savoir quelle licence est la plus appropriée à votre projet, rendez-vous sur cette page : https://choosealicense.com/.

Ajoutez la licence [**GPL-2**](https://choosealicense.com/licenses/gpl-2.0/) à votre projet :

```{r}
## Ajout d'une licence ----
rcompendium::add_license(license = "GPL-2")
```

Notez qu'un nouveau fichier a été créé : `LICENSE.md`. Celui-ci détaille le contenu de la license choisie. Regardez aussi le contenu du fichier `DESCRIPTION` : la section `License` a été mise à jour.


::: {.box-info}
`r fontawesome::fa_i("lightbulb")` **Bonne pratique #3**
<br/>
Toujours ajouter une **`LICENSE`** à un projet qui sera rendu public. Visitez le site [**Choose a License**](https://choosealicense.com/appendix/) pour choisir la plus appropriée à votre projet.
:::



<br />

## Ajout du compendium

...

::: {.box-info}
`r fontawesome::fa_i("lightbulb")` **Bonne pratique #4**
<br/>
...
:::

<br />

## Ajout d'un `README`

Les rôles d'un `README` sont de :

- décrire le projet (incluant sa citation),
- d'expliquer son contenu,
- d'expliquer son installation et son utilisation.


```{r}
## Ajout d'un README ----
rcompendium::add_readme_rmd(type = "compendium")
```


::: {.box-info}
`r fontawesome::fa_i("lightbulb")` **Bonne pratique #5**
<br/>
...
:::

<br />

## ------

## Étape 1 : Récupération du dépôt des exercices

Tout d'abord, il nous faut télécharger le dépôt GitHub des exercices de la formation
dans notre ordinateur.

-> https://github.com/rdatatoolbox/datarepo

. bouton vert "Code" > download zip


## Étape 2 : research compendium

Nous allons maintenant transformer notre dépôt en research compendium intégrant
les éléments essentiels de la structure d'un package R. Cela nous permettra
ensuite d'utiliser les outils de développement disponibles pour les packages R.

1. Transformez votre dépôt en research compendium à l'aide de la fonction
`rrtools::use_compendium()`. Lisez l'aide de cette fonction pour vous rendre compte
que les meilleures valeurs de paramètres sont les suivantes :

```{r eval = FALSE}
rrtools::use_compendium("../datatoolboxexos2021/", open = FALSE)
```

2. Suivez les instructions de la sortie de la fonction et éditez le fichier `DESCRIPTION`


## Étape 3 : première fonction

Dans la suite de la formation, vous utiliserez la base de données [**WildFinder**](https://www.worldwildlife.org/pages/wildfinder-database)
du WWF. Nous allons maintenant écrire les fonctions qui nous permettrons d'importer les 3 fichiers qui se trouvent dans `data/wildfinder/`.

1. Créez un fichier `R/data_wildfinder.R` à l'aide de la fonction `usethis::use_r()`

2. Créez 3 fonctions dans ce document avec leur entête `Roxygen2`. Ces fonctions
utiliseront le package `{readr}` pour lire les fichiers `.csv` qui seront localisés avec `{here}`

3. Ajoutez ces dépendances (`{readr}` et `{here}`) dans le fichier `DESCRIPTION` grâce à la fonction `usethis::use_package()`


## Étape 4 : petite pause ... ajout d'un README pour le compendium

Ajoutons un `README` au compendium.

1. Déplacez le fichier `README.md` de la racine du projet vers le répertoire `data/`

2. Ajoutez un fichier `README.Rmd` à la racine du projet à l'aide de la fonction
`rrtools::use_readme_rmd()` et modifiez-le pour qu'il corresponde un peu plus à
la structure de votre compendium. Vous pouvez à la fin du `README.Rmd` afficher les informations de votre
session (`utils::sessionInfo()`).

3. Re-compilez le fichier `README.Rmd` en `README.md`


## Étape 5-1 : utiliser le workflow "package"

Maintenant que notre compendium contient les éléments structurels d'un package R
(c.-à-d. un fichier `DESCRIPTION` et un répertoire `R/`) nous pouvons avantageusement
utiliser les outils de développement des packages R pour optimiser celui de notre
compendium.

1. Les packages nécessaires au bon déroulement de vos analyses
(ainsi que leurs dépendences) peuvent être installés ou mis à jour à l'aide de la
fonction `devtools::install_deps()` !

(2. Documentez les fonctions qu'expose votre compendium à l'aide la fonction
`devtools::document()`. Explorez le répertoire `man/` fraichement créé, et
regardez-le contenu du fichier `NAMESPACE`) -> à vrai dire on ne le fait souvent qu'à la fin ... voir jamais.


## Étape 5-2 : chargement des fonctions

Pour rendre vos fonctions fraichement créées disponible à vos analyses, une solution est l'utilisation de la fonction `devtools::load_all()` qui a pour
effet principal de charger tous les fichiers présents dans le répetoire `R/`


## Étape 5-3 : utiliser le workflow "package"


3. Regardez la doc `?datatoolboxexos::data_eco_list`, et testez la fonction
`datatoolboxexos::data_eco_list()` (on pourrait automatiser ces tests en
utilisant `{testthat}`)

La page d'aide de la fonction `datatoolboxexos::data_eco_list`.


---


## Étape 6 : Utilisation des fonctions pour nos analyses

Nous avons maintenant 3 fonctions à disposition dans notre compendium. Nous pouvons
créer un premier script d'analyses pour le premier exercice sur le Tidyverse :
[**dplyr**](https://frbcesab.github.io/datatoolbox/exercises/dplyr/index.html)

<br/>

Ici, pour notre premier compendium, on va créer un fichier `.R` (ou plutôt `.Rmd` mais on le verra plus tard) par exercice dans un répertoire... `exercices/`
<br/>

On crééra aussi un répertoire `outputs/` dans lequel on pourra stocker les résultats de nos analyses.

1. Créez le fichier `exercices/exo_dplyr.R`

2. Modifiez-le pour afficher l'histogramme de la distribution du nombre d'espèces
de mammifères par écoregion dans un fichier `.png` sauvegardé dans `outputs/`

3. Exécutez le code de `exercices/exo_dplyr.R` et visualisez le `.png`


---

## Étape 7 : automatisation...

Il ne nous reste plus qu'à automatiser quelques étapes et nous aurons un
compendium fonctionnel, intégré dans un workflow qui assure une
reproductibilité minimale de nos analyses.

1. Créez un fichier `make.R` à la racine de votre projet

2. Modifiez-le de manière à enchainer les étapes suivantes :

  - installation/mise à jour des packages nécessaires aux analyses

  - chargement des fonctions

  - exécution du script `exercices/exo_dplyr.R`

3. Effacez le fichier `.png`

4. Compilez votre compendium en sourçant intégralement le fichier `make.R`


## Étape 8 : finalisation

Modifiez le `README.Rmd` du compendium pour qu'il reflète un peu mieux ce qui
se passe ici.

Le compendium est maintenant fonctionnel.


## Corrections {.appendix}


If you see mistakes or want to suggest changes, please 
[Create an issue](https://github.com/rdatatoolbox/rdatatoolbox.github.io/issues)
on the source repository.



## Reuse {.appendix}



The material of this website is licensed under Creative Commons Attribution 
[CC BY 4.0](https://creativecommons.org/licenses/by/4.0/).
Source code is available at https://github.com/rdatatoolbox/rdatatoolbox.github.io/.


## Citation {.appendix}



Casajus N, Bonnici I, Dray S, Gimenez O, Guéry L, Guilhaumon F, Schiettekatte NMD & Siberchicot A (2022) 
Workshop FRB-CESAB & GdR EcoStat: Data Toolbox for Reproducible Research in Computational Ecology. 
Zenodo. <http://doi.org/10.5281/zenodo.4262978>.
